<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    <link rel="stylesheet" href="./assets/css/datatables.css" />
    <link rel="stylesheet" href="./assets/css/bootstrap.css" />
    <script src="env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <aside>
      <div class="top">
        <a href="./index.html" class="d-block">
          <img src="./assets/images/logo-white.svg" height="48px" class="logo" alt="">
        </a>
        <ul class="list-unstyled ps-0 mb-0">
          <li class="side-link active">
            <a href="./dashboard.html">
              <span class="material-symbols material-symbols-rounded"
                >team_dashboard</span
              >
              Dashboard
            </a>
          </li>
          <li class="side-link">
            <a href="./registeredpatients.html">
              <span class="material-symbols material-symbols-rounded"
                >person</span
              >
              Patients
            </a>
          </li>
          <li class="side-link">
            <a href="#" id="messagesanchor">
              <span class="material-symbols material-symbols-rounded"
                >mail</span
              >
              Messages
              <!-- <div class="badge">New</div> -->
            </a>
          </li>
          <li class="side-link">
            <a href="./profile.html">
              <span class="material-symbols material-symbols-rounded"
                >settings</span
              >
              Settings
            </a>
          </li>
          <li class="side-link">
            <a href="./activate.html">
              <span class="material-symbols material-symbols-rounded"
                >shop</span
              >
              Activate Device
            </a>
          </li>
          <li class="side-link">
            <a href="./orderdevice.html">
              <span class="material-symbols material-symbols-rounded"
                >shop</span
              >
              Order Device
            </a>
          </li>

        </ul>
      </div>
      <div class="bottom">
        <div class="side-link">
          <a href="" id="logout-btn">
            <span class="material-symbols material-symbols-rounded"
              >logout</span
            >
            Logout
          </a>
        </div>
      </div>
    </aside>
    <main>
      <header>
        <div class="container">
          <div class="search-container">
            <a href="" class="logo">Udatum</a>
            <button type="button" class="search" id="search">
              <span class="material-symbols material-symbols-rounded"
                >search</span
              >
            </button>
            <form action="" class="w-100">
              <input
                type="search"
                class="form-control w-100"
                name=""
                id=""
                placeholder="Search"
              />
              <button class="btn btn-primary rounded-pill">
                <span class="material-symbols material-symbols-rounded"
                  >search</span
                >
              </button>
            </form>
          </div>
          <div class="right">
            <div class="dropdown">
              <button
                type="button"
                class="notifications unread"
                type="button"
                id="dropdownMenuButton1"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <span class="material-symbols material-symbols-rounded"
                  >notifications</span
                >
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <li><a class="dropdown-item" href="#">Action</a></li>
                <li><a class="dropdown-item" href="#">Another action</a></li>
                <li>
                  <a class="dropdown-item" href="#">Something else here</a>
                </li>
              </ul>
            </div>

            <button
              type="button"
              class="avatar unread"
              id="user-initials"
            ></button>
            <button type="button" class="menu" id="menu">
              <span class="material-symbols material-symbols-rounded"
                >menu</span
              >
            </button>
          </div>
        </div>
      </header>
      <div class="container">
        <div class="top-bar">
          <div class="float-start">
            <h5 class="fw-bold">Profile Settings</h5>
          </div>
          <div class="date-time" id="clock">
            <span class="me-4"></span>
            <span></span>
          </div>
        </div>
      </div>
      <div class="content">
        <div
          class="patients-box d-flex flex-column justify-content-between"
          style="height: calc(80vh - 120px)"
        >
          <div>
            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link active"
                  id="pills-profile-tab"
                  data-bs-toggle="pill"
                  data-bs-target="#pills-profile"
                  type="button"
                  role="tab"
                  aria-controls="pills-profile"
                  aria-selected="false"
                >
                  Profile
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button
                  class="nav-link"
                  id="pills-contact-tab"
                  data-bs-toggle="pill"
                  data-bs-target="#pills-contact"
                  type="button"
                  role="tab"
                  aria-controls="pills-contact"
                  aria-selected="false"
                >
                  Change Password
                </button>
              </li>
            </ul>
            <div class="tab-content profile-table" id="pills-tabContent">
              
                <div
                  class="tab-pane fade show active"
                  id="pills-profile"
                  role="tabpanel"
                  aria-labelledby="pills-profile-tab"
                >
                <form>
                  <table class="w-100">
                    <tr>
                      <td class="h5 text-center">Name</td>
                      <td>
                        <input
                          id="name1"
                          type="text"
                          class="form-control"
                          placeholder="Physician Name"
                          autocomplete="off"
                          
                        />
                        <span class="material-symbols material-symbols-rounded"
                          >format_ink_highlighter</span
                        >
                      </td>
                    </tr>
                    <tr>
                      <td class="h5 text-center">Email</td>
                      <td>
                        <p
                        id="email1"
                          class="form-control"
                        >emails</p>
                      </td>
                    </tr>
                  </table>
                  <div class="text-center">
                    <button class="btn btn-primary" type="button" onclick=" changename()">
                      <span class="material-symbols material-symbols-rounded"
                        >check</span
                      >
                      Save
                    </button>
                  </div>
                </form>
                </div>
              <form
                class="tab-pane fade change-password-form"
                id="pills-contact"
                role="tabpanel"
                aria-labelledby="pills-contact-tab"
              >
                <table class="w-100">
                  <tr>
                    <td class="h5 text-center">New Password</td>
                    <td>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Password"
                        id="new-password"
                        autocomplete="off"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td class="h5 text-center">Confirm Password</td>
                    <td>
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Confirm Password"
                        id="confirm-new-password"
                        autocomplete="off"
                      />
                    </td>
                  </tr>
                </table>
                <div class="text-center">
                  <button class="btn btn-primary" type="button" onclick=" changePassword()">
                    <span class="material-symbols material-symbols-rounded"
                      >check</span
                    >
                    Save
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal -->
    <div
      class="modal fade"
      id="patientadded"
      tabindex="-1"
      aria-labelledby="patientaddedLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="patientaddedLabel"></h5>
            <button
              class="btn btn-light text-danger bg-transparent btn-lg"
              data-bs-dismiss="modal"
              aria-label="Close"
            >
              <span class="material-symbols material-symbols-rounded top-0"
                >cancel</span
              >
            </button>
          </div>
          <div class="modal-body">
            <div class="text-center">
              <img src="./assets/images/patientadded.png" class="mb-4" alt="" />
              <h5 class="fw-bold mb-5 pb-2">PATIENT SUCCESSFULLY ADDED.</h5>
              <a href="" class="btn btn-primary btn-lg px-xl-4 mx-3">
                <span class="material-symbols material-symbols-rounded"
                  >check</span
                >
                Show
              </a>
              <button class="btn btn-outline-primary btn-lg px-xl-4 mx-3">
                <span class="material-symbols material-symbols-rounded"
                  >add</span
                >
                Add Another Patient
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="./assets/js/all.js"></script>
    <script src="./assets/js/script.js"></script>
    <script src="./assets/js/datatables.js"></script>
    <script src="./assets/js/logout.js"></script>
    <div class="loading" id="loader1" style="visibility: hidden;">Loading&#8230;</div>
    <script>
      $(document).ready(function () {
        var token = localStorage.getItem('token');
        var user_ida = localStorage.getItem('id');
var messagesanchor = document.getElementById("messagesanchor");
  messagesanchor.setAttribute("href", `${clientbaseurl}/doctor/chat.html?id=${user_ida}`);

        // get-one-doctor/:id
      // console.log(token)
      if(token == null){
        window.location.replace("login.html");
      }
      else{
        $.ajax({
              type: "get",
              url: `${baseurl}/patient-list-of-a-doctor`,
              timeout: 0,
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              success: function (response) {
                  // $("#div11").html(result);
                  console.log("success");
                  // document.getElementById("loader1").style.visibility = "hidden";
              },
              error: function(response) {
                // console.log(response);
                
                if(response.responseJSON.message == "Authentication failed"){
                  window.location.replace("login.html");
                    }
              }
          });
      }
        if ($(window).width() < 768) {
          $("#search").click(function () {
            $(this).next().slideToggle();
          });
        }

        if ($(window).width() < 1100) {
          $("#menu").click(function () {
            $("aside").toggleClass("d-flex");
          });
        }
      });
    </script>
    <script>
      $(document).ready(function () {
        var table = $("#example").DataTable({
          dom: "Bfrtip",
          lengthMenu: [8, 32, 50, 75, 100],
        });
      });
      //  code for clock

      $(document).ready(function () {
        // Update clock display every second
        setInterval(function () {
          var now = new Date();

          // Format date and time
          var date = now.toLocaleDateString("en-US", {
            day: "numeric",
            month: "long",
            year: "numeric",
          });
          var hours = now.getHours();
          var minutes = now.getMinutes();
          var seconds = now.getSeconds();
          var ampm = hours >= 12 ? "PM" : "AM";
          hours = hours % 12;
          hours = hours ? hours : 12;
          minutes = minutes < 10 ? "0" + minutes : minutes;
          seconds = seconds < 10 ? "0" + seconds : seconds;
          var time = hours + ":" + minutes + ":" + seconds + " " + ampm;

          // Display date and time in clock element
          $("#clock").text(date + " " + time);
        }, 1000);
      });
      // code for logged-in user initials

      $(document).ready(function () {
        // Check if user is logged in and display name initials
        var token = localStorage.getItem("token");
        // Extract the user's name from the token
        var name = JSON.parse(atob(token.split(".")[1])).name;

        // Display the first two letters of the name in the designated element
        var initials = name.substr(0, 2).toUpperCase();
        $("#user-initials").text(initials);
      });
    </script>
    <script>
      // code for change password
      function changePassword(event) {

        document.getElementById("loader1").style.visibility = "visible";
        const token = localStorage.getItem("token");
        const userId = JSON.parse(atob(token.split(".")[1])).id; // Decode JWT token to retrieve user ID
        // Decode the token to retrieve the user information
        const user = JSON.parse(atob(token.split(".")[1]));

        const newPassword = $("#new-password").val();
        const confirmPassword = $("#confirm-new-password").val();

        if (newPassword !== confirmPassword) {
          Swal.fire("Passwords do not match!", "", "error");
          return;
        }
        // event.preventDefault();
        $.ajax({
          url: `${baseurl}/update-password`,
          type: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          data: {
            userId: userId,
            newPassword: newPassword,
            confirmPassword: confirmPassword,
          },
          success: function () {
            Swal.fire({
                    icon: 'success',
                    title: 'Successful!',
                    text: "Password Changed Successfully",
                    allowOutsideClick: false
                  })
                  $( 'button.swal2-confirm' ).click(function() {
                    window.location.reload();
                  });
                  document.getElementById("loader1").style.visibility = "hidden";
          },
          error: function (xhr, status, error) {
            if (xhr.status === 401) {
              Swal.fire("You are not authorized!", "", "error");
            } else {
              Swal.fire("Oops...", "Something went wrong!", "error");
            }
          },
        });
      }
      
      function changename(event) {
        // event.preventDefault();
        document.getElementById("loader1").style.visibility = "visible";
        const token = localStorage.getItem("token");
        const userId = JSON.parse(atob(token.split(".")[1])).id; // Decode JWT token to retrieve user ID
        // Decode the token to retrieve the user information
        const user = JSON.parse(atob(token.split(".")[1]));

        const newname = $("#name1").val();
        $.ajax({
          url: `${baseurl}/update-name`,
          type: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
          },
          data: {
            userId: userId,
            newname: newname,
          },
          success: function () {
            Swal.fire({
                    icon: 'success',
                    title: 'Successful!',
                    text: "Name Changed Successfully",
                    allowOutsideClick: false
                  })
                  $( 'button.swal2-confirm' ).click(function() {
                    window.location.reload();
                  });
            document.getElementById("loader1").style.visibility = "hidden";
          },
          error: function (xhr, status, error) {
            if (xhr.status === 401) {
              Swal.fire("You are not authorized!", "", "error");
            } else {
              Swal.fire("Oops...", "Something went wrong!", "error");
            }
            document.getElementById("loader1").style.visibility = "hidden";
          },
        });
      }
      
// Attach click event handler to logout button

        // populate user profile information
        getUserProfile();
          

      // GETT USER PROFILE
      function getUserProfile() {
        const token = localStorage.getItem("token");
        const userId = JSON.parse(atob(token.split(".")[1])).id; // Decode JWT token to retrieve user ID
        // Decode the token to retrieve the user information
        const user = JSON.parse(atob(token.split(".")[1]));
        
        $.ajax({
          url: `${baseurl}/get-one-doctor/${userId}`,
          type: "GET",
          headers: {
            Authorization: "Bearer " + token,
          },
          success: function (data) {
            $("#name1").val(data.name);
            document.getElementById("email1").innerHTML = data.email;
            // var email1 = $("#email1");
            // email1.innerHTML = data.email;
          },
          error: function () {
            Swal.fire("Oops...", "Something went wrong!", "error");
          },
        });
      }


      // code

 
    </script>
  </body>
</html>
