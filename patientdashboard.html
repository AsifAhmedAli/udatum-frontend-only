<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Details</title>
    <link rel="stylesheet" href="./assets/css/datatables.css" />
    <link rel="stylesheet" href="./assets/css/bootstrap.css" /><script src="env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <aside>
      <div class="top">
        <a href="./index.html" class="d-block">
          <img
            src="./assets/images/logo-white.svg"
            height="48px"
            class="logo"
            alt=""
          />
        </a>
        <ul class="list-unstyled ps-0 mb-0">
          <li class="side-link active">
            <a href="./patientdashboard.html">
              <span class="material-symbols material-symbols-rounded"
                >team_dashboard</span
              >
              Dashboard
            </a>
          </li>
          <li class="side-link">
            <a href="./chat.html" id="messagesanchor">
              <span class="material-symbols material-symbols-rounded"
                >mail</span
              >
              Messages
              <!-- <div class="badge">New</div> -->
            </a>
          </li>
          <li class="side-link">
            <a href="./patienthealth.html">
              <span class="material-symbols material-symbols-rounded"
                >diversity_4</span
              >
              My Health
            </a>
          </li>
        </ul>
      </div>
      <div class="bottom">
        <div class="side-link">
          <a href="" id="logout-btn">
            <span class="material-symbols material-symbols-rounded" 
              >logout</span
            >
            Logout
          </a>
        </div>
      </div>
    </aside>
    <main>
      <header>
        <div class="container">
          <div class="search-container">
            <a href="" class="logo">Udatum</a>
            <button type="button" class="search" id="search">
              <span class="material-symbols material-symbols-rounded"
                >search</span
              >
            </button>

          </div>
          <div class="right">


            <!-- <button type="button" class="avatar unread">JD</button> -->
            <button type="button" class="avatar unread" id="user-initials"></button>
            <button type="button" class="menu" id="menu">
              <span class="material-symbols material-symbols-rounded"
                >menu</span
              >
            </button>
          </div>
        </div>
      </header>
      <div class="container">
        <div class="top-bar">
          <div class="date-time" id="clock">
            <span class="me-4"></span>
            <span></span>
          </div>
        </div>
      </div>
      <div class="content">
        <div class="patient-details-box bg-white mb-xl-5 mb-3">
          <div
            class="d-flex align-items-center justify-content-between flex-wrap"
          >
            <div class="left">
              <h5 class="fw-bold me-xl-5 me-4">Your Profile</h5>
            </div>
          </div>
          <div class="row">
            <div class="col-xl-5 col-12">
              <table class="table table-borderless mb-0">
                <tbody>
                  <tr>
                    <th scope="col">Patient Email</th>
                    <td id="pemail"></td>
                  </tr>
                  <tr>
                    <th scope="col">Birth Date</th>
                    <td id="pbday"></td>
                  </tr>
                  <tr>
                    <th scope="col">Assigned Physician</th>
                    <td id="dname"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <hr />
          <div class="row gx-xl-5 gx-3">
            <div class="col-md-6">
              <h5 class="fw-bold mb-4">Linked Devices</h5>
              <table class="patient-linked-dev">
                <thead>
                  <tr>
                    <th scope="col">Device Name</th>
                    <th scope="col">Device ID</th>
                  </tr>
                </thead>
                <tbody id="devices_list">
                </tbody>
              </table>
            </div>
            <div class="col-md-6">
              <!-- <h5 class="fw-bold mb-4">Forecasts</h5>
              <table class="table table-bordered forecasts">
                <tr>
                  <td>
                    Lorem ipsum dolor sit amet consectetur. Eget elit quam in
                    blandit vulputate.
                  </td>
                </tr>
                <tr>
                  <td>
                    Lorem ipsum dolor sit amet consectetur. Eget elit quam in
                    blandit vulputate.
                  </td>
                </tr>
                <tr>
                  <td>
                    Lorem ipsum dolor sit amet consectetur. Eget elit quam in
                    blandit vulputate.
                  </td>
                </tr>
              </table> -->
            </div>
          </div>
        </div>
      </div>
    </main>
    <div class="loading" id="loader1" style="visibility: hidden;">Loading&#8230;</div>
    <script src="./assets/js/all.js"></script>
    <script src="./assets/js/script.js"></script>
    <script src="./assets/js/datatables.js"></script>
    <script>
      $(document).ready(function () {
        if ($(window).width() < 768) {
          $("#search").click(function () {
            $(this).next().slideToggle();
          });
        }

        if ($(window).width() < 1100) {
          $("#menu").click(function () {
            $("aside").toggleClass("d-flex");
          });
        }
      });
    </script>
    <script>
        $(document).ready(function() {
  // Check if user is logged in and display name initials
  var token = localStorage.getItem('token');
// Extract the user's name from the token
var name = JSON.parse(atob(token.split('.')[1])).name;

// Display the first two letters of the name in the designated element
var initials = name.substr(0, 2).toUpperCase();
$('#user-initials').text(initials);
});

//  code for clock

$(document).ready(function() {
  // Update clock display every second
  setInterval(function() {
    var now = new Date();
    
    // Format date and time
    var date = now.toLocaleDateString('en-US', {day: 'numeric', month: 'long', year: 'numeric'});
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var seconds = now.getSeconds();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12;
    minutes = minutes < 10 ? '0' + minutes : minutes;
    seconds = seconds < 10 ? '0' + seconds : seconds;
    var time = hours + ':' + minutes + ':' + seconds + ' ' + ampm;
    
    // Display date and time in clock element
    $('#clock').text(date + ' ' + time);
  }, 1000);
});

//  Logout Button code
$(document).ready(function() {
    var token = localStorage.getItem('token');
    var id = localStorage.getItem('id');
    function getMonthName(monthNumber) {
          const date = new Date();
          date.setMonth(monthNumber - 1);
          return date.toLocaleString('en-US', { month: 'long' });
        }
      // console.log(token)
      if(token == null){
        window.location.replace("login_patient.html");
      }
      else{
        document.getElementById("loader1").style.visibility = "visible";
        $.ajax({
              type: "get",
              url: `${baseurl}/get-one-patient/${id}`,
              timeout: 0,
              headers: {
                "Authorization": `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              success: function (response) {
                  // $("#div11").html(result);
                  console.log("success");
                  var dateFormat1= new Date(response.date_of_birth);
                  document.getElementById("pemail").innerText = response.email;
                  document.getElementById("pbday").innerText = dateFormat1.getDate()-1+"/"+getMonthName((dateFormat1.getMonth()+1))+"/"+dateFormat1.getFullYear();
                  document.getElementById("dname").innerText = response.doctor_name;
                  $.ajax({
                          type: "get",
                          url: `${baseurl}/get-one-patient-devices/${id}`,
                          timeout: 0,
                          headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json",
                          },
                          success: function (response1) {

                              // $("#div11").html(result);
                              // console.log
                              response1.forEach(key => {
                                document.getElementById("devices_list").innerHTML += 
                              `<tr>
                                <td>${key.device_name}</td>
                                <td>${key.device_barcode}</td>
                              </tr>`;                                
                              });
                              console.log(response1);

                              // document.getElementById("loader1").style.visibility = "hidden";
                          }
                      });
                  document.getElementById("loader1").style.visibility = "hidden";
              },
              error: function(response) {
                // console.log(response);
                
                if(response.responseJSON.message == "Authentication failed"){
                  window.location.replace("login_patient.html");
                    }
              }
          });
      }
  // Attach click event handler to logout button
  $('#logout-btn').click(function(event) {
    event.preventDefault();
    // Display confirmation dialog using SweetAlert2
    Swal.fire({
      title: 'Are you sure you want to logout?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, logout'
    }).then((result) => {
      if (result.isConfirmed) {
        // If user confirms logout, get authentication token from local storage
        var token = localStorage.getItem('token');

        // Send POST request to logout API endpoint
        $.ajax({
          url: `${baseurl}/patient-logout`,
          type: 'GET',
          headers: {
            'Authorization': 'Bearer ' + token
          },
          success: function(response) {
            // If logout successful, remove token from local storage and redirect to login page
            localStorage.removeItem('token');
            localStorage.removeItem('id');
            window.location.href = './login_patient.html';
          },
          error: function(xhr, status, error) {
            // If error occurred, display error message using SweetAlert2
            Swal.fire({
              title: 'Error',
              text: 'Logout failed: ' + error,
              icon: 'error',
              confirmButtonColor: '#3085d6',
              confirmButtonText: 'OK'
            });
          }
        });
      }
    });
  });
});

    </script>
  </body>
</html>
